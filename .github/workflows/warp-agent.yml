name: Warp AI Agent (@warp-fix trigger)

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  warp-fix:
    # Only trigger on @warp-fix command
    if: |
      (
        github.event_name == 'issue_comment' ||
        github.event_name == 'pull_request_review_comment'
      ) &&
      contains(github.event.comment.body, '@warp-fix')
    runs-on: ubuntu-latest
    permissions:
      contents: write # Allow creating branches and editing files
      pull-requests: write # Allow creating and updating pull requests
      issues: write # Allow commenting on issues
    env:
      WARP_API_KEY: ${{ secrets.WARP_API_KEY }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Load fix instructions
        id: load-instructions
        run: |
          # Get the issue or PR number from the event
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          else
            ISSUE_NUMBER="${{ github.event.pull_request.number }}"
          fi
          
          # Read the template
          INSTRUCTIONS=$(cat .github/warp_fix_prompt.md)
          
          # Use heredoc to preserve multiline content with context prepended
          echo "CUSTOM_INSTRUCTIONS<<EOF" >> $GITHUB_OUTPUT
          echo "# GitHub Context" >> $GITHUB_OUTPUT
          echo "- Repository: ${{ github.repository }}" >> $GITHUB_OUTPUT
          echo "- Issue/PR Number: ${ISSUE_NUMBER}" >> $GITHUB_OUTPUT
          echo "- Triggered by: ${{ github.event.comment.user.login }}" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "$INSTRUCTIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Install Warp CLI
        run: |
          # Add Warp package repository and install
          curl -fsSL https://releases.warp.dev/linux/keys/warp.asc | sudo gpg --dearmor -o /usr/share/keyrings/warp-archive-keyring.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/warp-archive-keyring.gpg] https://releases.warp.dev/linux/deb stable main" | sudo tee /etc/apt/sources.list.d/warp.list
          sudo apt update
          sudo apt install warp-cli -y
          which warp-cli || { echo "warp-cli not found"; exit 1; }

      - name: Run Warp Agent on Issue
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_BODY=$(gh issue view $ISSUE_NUMBER --json body -q .body)
          COMMENT_BODY="${{ github.event.comment.body }}"
          
          # Build comprehensive prompt with instructions
          echo "${{ steps.load-instructions.outputs.CUSTOM_INSTRUCTIONS }}" > prompt.txt
          echo "" >> prompt.txt
          echo "---" >> prompt.txt
          echo "" >> prompt.txt
          echo "## Issue Details" >> prompt.txt
          echo "" >> prompt.txt
          echo "**Issue #${ISSUE_NUMBER}**: ${ISSUE_TITLE}" >> prompt.txt
          echo "" >> prompt.txt
          echo "**Description:**" >> prompt.txt
          echo "$ISSUE_BODY" >> prompt.txt
          echo "" >> prompt.txt
          echo "**User Comment:**" >> prompt.txt
          echo "$COMMENT_BODY" >> prompt.txt
          echo "" >> prompt.txt
          echo "---" >> prompt.txt
          echo "" >> prompt.txt
          echo "**Your task:** Analyze the issue and implement a fix." >> prompt.txt
          echo "" >> prompt.txt
          echo "You have WRITE ACCESS to this repository. You can:" >> prompt.txt
          echo "- Edit files directly" >> prompt.txt
          echo "- Create branches with: git checkout -b fix/issue-${ISSUE_NUMBER}-warp-ai" >> prompt.txt
          echo "- Commit changes with: git commit -m \"fix: description\"" >> prompt.txt
          echo "- Push branches with: git push -u origin <branch-name>" >> prompt.txt
          echo "- Create PRs with: gh pr create" >> prompt.txt
          echo "" >> prompt.txt
          echo "Prefer creating a PR with the fix over just commenting the solution." >> prompt.txt
          
          echo "Running Warp Agent..."
          warp-cli agent run \
            --prompt "$(cat prompt.txt)" > warp-response.md
          
          cat warp-response.md

      - name: Comment Response
        if: always()
        run: |
          # Determine issue/PR number
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          else
            ISSUE_NUMBER="${{ github.event.pull_request.number }}"
          fi
          
          # Post the agent's response as a comment
          if [ -f warp-response.md ]; then
            gh issue comment $ISSUE_NUMBER --body-file warp-response.md
          fi
